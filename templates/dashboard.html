<!DOCTYPE html>
<html lang="en">
<head>
    <title>AI Assistant Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
</head>
<body>

    <div>
        <form action="/logout" method="post" style="float:right;">
            <button type="submit">Log out</button>
        </form>
        <a href="/settings">⚙️ Agent Settings</a>
    </div>

    <h1>📡 iMessage Bot</h1>

    <h2>📩 Send Bulk Message</h2>
    <form action="/send_bulk" method="post">
        <label>Phone numbers (comma or newline separated):</label><br>
        <textarea name="phones" rows="3" placeholder="+11234567890, +10987654321"></textarea>
        <br>
        <textarea name="message" placeholder="Enter message"></textarea>
        <button type="submit">Send</button>
    </form>

    <h2>⏳ Schedule a Message</h2>
    <form action="/schedule_message" method="post">
        <label>Phone numbers (comma or newline separated):</label><br>
        <textarea name="phones" rows="3" placeholder="+11234567890, +10987654321"></textarea>
        <br>
        <input type="time" name="time">
        <textarea name="message" placeholder="Enter message"></textarea>
        <button type="submit">Schedule</button>
    </form>
    <!-- Legacy AI settings removed; manage allowlist and trigger under Agent Settings page. -->

    <h2>📩 Real-Time Messages</h2>
    <ul id="messages"></ul>

    <h2>📊 AI Response Log</h2>
    <ul id="analytics"></ul>

    <script>
        var socket = io();
        var currentStreams = {};

        function appendTextItem(prefixEmoji, strongText, trailingText, listId) {
            var li = document.createElement('li');
            if (prefixEmoji) li.append(prefixEmoji + ' ');
            var strong = document.createElement('strong');
            strong.textContent = strongText;
            li.appendChild(strong);
            if (trailingText) li.append(' ', trailingText);
            document.getElementById(listId).appendChild(li);
        }

        // Listen for messages that are sent
        socket.on("message_sent", function(data) {
            console.log("✅ Message Sent:", data);
            var ctx = data.chat_type ? (data.chat_type === 'Group' ? ' [Group]' : ' [Direct]') : '';
            var toLabel = (data.chat_type === 'Group' && data.chat_guid) ? data.chat_guid : data.phone;
            appendTextItem('✅', `Sent to ${toLabel}${ctx}:`, data.message || '', 'messages');
        });

        // Listen for new incoming messages
        socket.on("new_message", function(data) {
            console.log("📩 New Message:", data);
            var ctx = data.chat_type ? (data.chat_type === 'Group' ? ' [Group]' : ' [Direct]') : '';
            var fromLabel = (data.chat_type === 'Group' && data.chat_guid) ? (data.phone + ' | ' + data.chat_guid) : data.phone;
            appendTextItem('📩', `From ${fromLabel}${ctx}:`, data.message || '', 'messages');

            if (data.response) {
                appendTextItem('🤖', 'AI Reply:', data.response || '', 'analytics');
            }
        });

        // Optional: show agent errors (e.g., DB permission issues)
        socket.on("agent_error", function(data) {
            console.error("Agent error:", data);
            var hint = data && data.hint ? (' ' + data.hint) : '';
            appendTextItem('⚠️', 'Agent Error:', (data && data.error ? data.error : '') + hint, 'messages');
        });

        // Streaming AI output
        socket.on("ai_stream", function(data) {
            console.log("🌀 AI Stream:", data);
            var key = (data.chat_type === 'Group' && data.chat_guid) ? data.chat_guid : data.phone || 'global';
            var el = currentStreams[key];
            if (!el) {
                el = document.createElement('li');
                el.dataset.key = key;
                el.innerHTML = '<strong>🤖 AI (streaming):</strong> <span class="content"></span>';
                document.getElementById('analytics').appendChild(el);
                currentStreams[key] = el;
            }
            var span = el.querySelector('.content');
            if (data.delta) {
                span.textContent += data.delta;
            }
            if (data.error) {
                el.innerHTML = '<strong>❌ AI Error:</strong> ' + data.error;
                delete currentStreams[key];
            }
            if (data.done) {
                var finalText = data.text || span.textContent || '';
                el.innerHTML = '<strong>🤖 AI Reply:</strong> ' + finalText;
                delete currentStreams[key];
            }
        });

        // Handle errors
        socket.on("connect_error", function(error) {
            console.error("❌ WebSocket Connection Error:", error);
        });
    </script>

</body>
</html>
